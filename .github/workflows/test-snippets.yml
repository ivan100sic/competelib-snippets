name: Test snippets

on:
  pull_request:

jobs:
  test-snippets:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout parent project
      uses: actions/checkout@v2
      with:
        repository: ivan100sic/snippets-cpp
        ref: main

    - name: Add Toolchain repository
      run: sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test

    - name: Install g++-11
      run: sudo apt-get install -y g++-11

    - name: Prepare CMake
      run: cd snippets-cpp && mkdir build && cd build && cmake .. -D CMAKE_CXX_COMPILER=g++-11 
      
    - name: Build parent
      run: cmake --build . && cd ../..
      
    - name: Checkout this repo
      uses: actions/checkout@v2

    - name: Run tests
      run: ./snippets-cpp/build/test --compiler-path=g++-11 `find ./${{ github.repository }} -name "*.cpp"`
      
    - name: Verify snippet syntax
      run: ./snippets-cpp/build/generate `find ./${{ github.repository }} -name "*.cpp"` --cpp-standard=20 > /dev/null
